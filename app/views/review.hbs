<div class="row">
    <div class="col">
        <h6>Файл '{{filename}}', выложенный {{user}}</h6>
    </div>
</div>
<iframe src="{{url}}" frameborder="0" height="600px" width="100%">
</iframe>
<div class="container mt-4">
    <div class="row mb-3">
        <div class="col-auto">
            <div class="row" id="star-container">
                <div class="col-auto">
                    Ваша оценка:
                </div>
                <div class="col-auto star">
                    <?xml version="1.0" ?><svg baseProfile="tiny" height="24px" id="Layer_1" version="1.2" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><path d="M9.362,9.158c0,0-3.16,0.35-5.268,0.584c-0.19,0.023-0.358,0.15-0.421,0.343s0,0.394,0.14,0.521    c1.566,1.429,3.919,3.569,3.919,3.569c-0.002,0-0.646,3.113-1.074,5.19c-0.036,0.188,0.032,0.387,0.196,0.506    c0.163,0.119,0.373,0.121,0.538,0.028c1.844-1.048,4.606-2.624,4.606-2.624s2.763,1.576,4.604,2.625    c0.168,0.092,0.378,0.09,0.541-0.029c0.164-0.119,0.232-0.318,0.195-0.505c-0.428-2.078-1.071-5.191-1.071-5.191    s2.353-2.14,3.919-3.566c0.14-0.131,0.202-0.332,0.14-0.524s-0.23-0.319-0.42-0.341c-2.108-0.236-5.269-0.586-5.269-0.586    s-1.31-2.898-2.183-4.83c-0.082-0.173-0.254-0.294-0.456-0.294s-0.375,0.122-0.453,0.294C10.671,6.26,9.362,9.158,9.362,9.158z"/></g></g></svg>
                </div>
                <div class="col-auto star">
                    <?xml version="1.0" ?><svg baseProfile="tiny" height="24px" id="Layer_1" version="1.2" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><path d="M9.362,9.158c0,0-3.16,0.35-5.268,0.584c-0.19,0.023-0.358,0.15-0.421,0.343s0,0.394,0.14,0.521    c1.566,1.429,3.919,3.569,3.919,3.569c-0.002,0-0.646,3.113-1.074,5.19c-0.036,0.188,0.032,0.387,0.196,0.506    c0.163,0.119,0.373,0.121,0.538,0.028c1.844-1.048,4.606-2.624,4.606-2.624s2.763,1.576,4.604,2.625    c0.168,0.092,0.378,0.09,0.541-0.029c0.164-0.119,0.232-0.318,0.195-0.505c-0.428-2.078-1.071-5.191-1.071-5.191    s2.353-2.14,3.919-3.566c0.14-0.131,0.202-0.332,0.14-0.524s-0.23-0.319-0.42-0.341c-2.108-0.236-5.269-0.586-5.269-0.586    s-1.31-2.898-2.183-4.83c-0.082-0.173-0.254-0.294-0.456-0.294s-0.375,0.122-0.453,0.294C10.671,6.26,9.362,9.158,9.362,9.158z"/></g></g></svg>
                </div>
                <div class="col-auto star">
                    <?xml version="1.0" ?><svg baseProfile="tiny" height="24px" id="Layer_1" version="1.2" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><path d="M9.362,9.158c0,0-3.16,0.35-5.268,0.584c-0.19,0.023-0.358,0.15-0.421,0.343s0,0.394,0.14,0.521    c1.566,1.429,3.919,3.569,3.919,3.569c-0.002,0-0.646,3.113-1.074,5.19c-0.036,0.188,0.032,0.387,0.196,0.506    c0.163,0.119,0.373,0.121,0.538,0.028c1.844-1.048,4.606-2.624,4.606-2.624s2.763,1.576,4.604,2.625    c0.168,0.092,0.378,0.09,0.541-0.029c0.164-0.119,0.232-0.318,0.195-0.505c-0.428-2.078-1.071-5.191-1.071-5.191    s2.353-2.14,3.919-3.566c0.14-0.131,0.202-0.332,0.14-0.524s-0.23-0.319-0.42-0.341c-2.108-0.236-5.269-0.586-5.269-0.586    s-1.31-2.898-2.183-4.83c-0.082-0.173-0.254-0.294-0.456-0.294s-0.375,0.122-0.453,0.294C10.671,6.26,9.362,9.158,9.362,9.158z"/></g></g></svg>
                </div>
                <div class="col-auto star">
                    <?xml version="1.0" ?><svg baseProfile="tiny" height="24px" id="Layer_1" version="1.2" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><path d="M9.362,9.158c0,0-3.16,0.35-5.268,0.584c-0.19,0.023-0.358,0.15-0.421,0.343s0,0.394,0.14,0.521    c1.566,1.429,3.919,3.569,3.919,3.569c-0.002,0-0.646,3.113-1.074,5.19c-0.036,0.188,0.032,0.387,0.196,0.506    c0.163,0.119,0.373,0.121,0.538,0.028c1.844-1.048,4.606-2.624,4.606-2.624s2.763,1.576,4.604,2.625    c0.168,0.092,0.378,0.09,0.541-0.029c0.164-0.119,0.232-0.318,0.195-0.505c-0.428-2.078-1.071-5.191-1.071-5.191    s2.353-2.14,3.919-3.566c0.14-0.131,0.202-0.332,0.14-0.524s-0.23-0.319-0.42-0.341c-2.108-0.236-5.269-0.586-5.269-0.586    s-1.31-2.898-2.183-4.83c-0.082-0.173-0.254-0.294-0.456-0.294s-0.375,0.122-0.453,0.294C10.671,6.26,9.362,9.158,9.362,9.158z"/></g></g></svg>
                </div>
                <div class="col-auto star">
                    <?xml version="1.0" ?><svg baseProfile="tiny" height="24px" id="Layer_1" version="1.2" viewBox="0 0 24 24" width="24px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><g><path d="M9.362,9.158c0,0-3.16,0.35-5.268,0.584c-0.19,0.023-0.358,0.15-0.421,0.343s0,0.394,0.14,0.521    c1.566,1.429,3.919,3.569,3.919,3.569c-0.002,0-0.646,3.113-1.074,5.19c-0.036,0.188,0.032,0.387,0.196,0.506    c0.163,0.119,0.373,0.121,0.538,0.028c1.844-1.048,4.606-2.624,4.606-2.624s2.763,1.576,4.604,2.625    c0.168,0.092,0.378,0.09,0.541-0.029c0.164-0.119,0.232-0.318,0.195-0.505c-0.428-2.078-1.071-5.191-1.071-5.191    s2.353-2.14,3.919-3.566c0.14-0.131,0.202-0.332,0.14-0.524s-0.23-0.319-0.42-0.341c-2.108-0.236-5.269-0.586-5.269-0.586    s-1.31-2.898-2.183-4.83c-0.082-0.173-0.254-0.294-0.456-0.294s-0.375,0.122-0.453,0.294C10.671,6.26,9.362,9.158,9.362,9.158z"/></g></g></svg>
                </div>
            </div>
        </div>
    </div>
    <div class="alert alert-danger d-none" role="alert" id="error">
    </div>
    <div class="alert alert-success d-none" role="alert" id="success">
    </div>
    <div class="form-floating">
        <textarea class="form-control" placeholder="Leave a comment here" id="textarea" style="height: 100px" id></textarea>
        <label for="textarea">Ваш отзыв</label>
    </div>
    <div class="row mt-2 mb-2">
        <div class="col-auto">
            <button class="btn btn-primary" onclick="sendReview()"  id="send-button">Оставить отзыв</button>
        </div>
    </div>
</div>

<script>
    const stars = document.getElementsByClassName('star');
    const starContainer = document.getElementById('star-container');
    let gradeIsSet = false;
    let grade = -1;
    starContainer.addEventListener('mouseleave', ()=>{
        if(!gradeIsSet){
            for(let i = 0; i<stars.length; i++){
                stars[i].classList.remove('star-active');
            }
        }
    });
    Array.from(stars).forEach((element, index) => {
        element.addEventListener('mouseenter', ()=>{
            for(let i = 0; i<stars.length; i++){
                if(i<=index){
                    stars[i].classList.add('star-active');
                }else{
                    stars[i].classList.remove('star-active');
                }
            }
        });
        element.addEventListener('click', ()=>{
            gradeIsSet = true;
            grade = index+1;
        })
    });

    const errorBlock = document.getElementById('error');
    const successBlock = document.getElementById('success');

    function sendReview(){
        const textarea = document.getElementById('textarea');
        if(textarea.value == ''){
            errorBlock.classList.remove('d-none');
            errorBlock.innerHTML = "Необходимо написать отзыв!"
        }
        if(!gradeIsSet){
            errorBlock.classList.remove('d-none');
            errorBlock.innerHTML = "Необходимо поставить оценку!"
        }
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        const fileId = params.get('id');
        fetch('/api/review', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body:JSON.stringify({
                grade,
                fileId,
                comment: textarea.value,
            })
        }).then(async (res)=>{
            const body = await res.json();
            if(res.ok){
                errorBlock.classList.add('d-none');
                successBlock.classList.remove('d-none');
                successBlock.innerHTML = `Отзыв успешно отправлен!`;
                document.getElementById('send-button').classList.add('disabled');
            }else{
                errorBlock.classList.remove('d-none');
                errorBlock.innerHTML = "Ошибка! ";
                body.forEach(error=>{
                    errorBlock.innerHTML += error+" ";
                })
            }
        })
    }
</script>